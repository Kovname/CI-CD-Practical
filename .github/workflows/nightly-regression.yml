# –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ (Nightly Regression)
# –ó–∞–≤–¥–∞–Ω–Ω—è 3 (–°—Ü–µ–Ω–∞—Ä—ñ–π 2): –†–µ–≥—Ä–µ—Å—ñ–π–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑–∞ —Ä–æ–∑–∫–ª–∞–¥–æ–º

name: Nightly Regression Tests

on:
  # –ó–∞–ø—É—Å–∫ –∑–∞ —Ä–æ–∑–∫–ª–∞–¥–æ–º (cron —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
  schedule:
    # –©–æ–Ω–æ—á—ñ –æ 02:00 UTC (04:00 –∑–∞ –ö–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º)
    - cron: "0 2 * * *"

  # –î–æ–∑–≤–æ–ª—è—î —Ä—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ GitHub UI
  workflow_dispatch:
    inputs:
      test_suite:
        description: "–¢–µ—Å—Ç–æ–≤–∏–π –Ω–∞–±—ñ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫—É"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - smoke
          - integration

jobs:
  regression-tests:
    name: üåô Nightly Regression Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60 # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì¶ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Node.js —Ç–µ—Å—Ç–∏
      - name: üì¶ Install Node.js dependencies
        working-directory: nodejs-demo
        run: npm ci

      - name: üß™ Run Node.js regression tests
        working-directory: nodejs-demo
        run: npm test

      # Python —Ç–µ—Å—Ç–∏
      - name: üì¶ Install Python dependencies
        working-directory: python-demo
        run: |
          pip install -r requirements.txt
          pip install coverage

      - name: üß™ Run Django regression tests
        working-directory: python-demo
        run: |
          python manage.py migrate
          coverage run --source='.' manage.py test
          coverage report

      - name: üìä Generate test report
        if: always()
        run: |
          echo "# üåô Nightly Regression Report" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫—É:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## –†–µ–∑—É–ª—å—Ç–∞—Ç–∏:" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- Django: ‚úÖ" >> $GITHUB_STEP_SUMMARY

  # –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
  notify:
    name: üìß Send Notification
    runs-on: ubuntu-latest
    needs: regression-tests
    if: always()

    steps:
      - name: üìß Notify on failure
        if: needs.regression-tests.result == 'failure'
        run: |
          echo "‚ùå –†–µ–≥—Ä–µ—Å—ñ–π–Ω—ñ —Ç–µ—Å—Ç–∏ –Ω–µ –ø—Ä–æ–π—à–ª–∏!"
          echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –∑—ñ Slack, Discord, Email —Ç–æ—â–æ
